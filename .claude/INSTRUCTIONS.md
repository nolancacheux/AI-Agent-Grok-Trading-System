# Development Instructions

These instructions must be followed for all work in this repository.

## General Rules

- Never use emojis in code, commits, or documentation
- Communicate in English in code comments
- Never mention "Claude", "AI assistant", or similar in commits or code comments
- Focus commits on actual code/feature changes only
- Keep code clean, simple, and well-documented
- Never use ugly separator lines like `# ====...` or `// ----...` in code or config files

## Project-Specific Rules

### Trading Bot Safety

1. **Paper Trading Only**: This project uses paper (simulated) trading. Never configure for live trading without explicit authorization.

2. **API Key Security**:
   - Never commit API keys or credentials (even once - they stay in git history forever)
   - Always use environment variables
   - Never log API keys, even partially
   - Repo may become public later, so treat every commit as if it's already public

3. **Order Validation**:
   - Validate all orders before execution
   - Implement maximum position limits
   - Log all trading decisions with reasoning

### Code Style

#### Python (Backend)

```python
# Use type hints everywhere
def execute_trade(symbol: str, quantity: int, action: str) -> TradeResult:
    """Execute a trade on IBKR.

    Args:
        symbol: Stock ticker symbol (e.g., "AAPL")
        quantity: Number of shares
        action: "buy" or "sell"

    Returns:
        TradeResult with execution details

    Raises:
        InsufficientFundsError: If not enough cash
        MarketClosedError: If market is closed
    """
    pass
```

- Use Ruff for formatting and linting
- Line length: 100 characters
- Use docstrings for all public functions
- Use `logging` module, not print statements

#### TypeScript (Frontend)

```typescript
// Use strict TypeScript
interface TradeOrder {
  symbol: string;
  quantity: number;
  action: 'buy' | 'sell';
  reasoning: string;
  evaluatedRisk: number;
}
```

- Use ESLint + Prettier
- Prefer functional components with hooks
- Use TypeScript strict mode
- Export types from dedicated type files

### Git Workflow

#### Branch Naming

| Prefix | Purpose | Example |
|--------|---------|---------|
| `feat/` | New features | `feat/add-portfolio-chart` |
| `fix/` | Bug fixes | `fix/websocket-reconnect` |
| `docs/` | Documentation | `docs/update-setup-guide` |
| `refactor/` | Code refactoring | `refactor/extract-trade-utils` |
| `test/` | Adding tests | `test/add-order-validation-tests` |

#### Commit Messages

Use conventional commits:

```
feat: add real-time portfolio value display
fix: handle market closed error gracefully
docs: add IBKR setup instructions for France
refactor: extract market data fetching logic
test: add unit tests for order validation
```

**Never include in commits:**
- References to Claude or AI assistance
- Mentions of CLAUDE.md or INSTRUCTIONS.md
- Time estimates or planning notes

### Pre-Commit Checklist

Before committing, ensure:

1. [ ] Code compiles/runs without errors
2. [ ] All tests pass
3. [ ] No secrets or API keys in code
4. [ ] Type hints added (Python) / Types defined (TypeScript)
5. [ ] Docstrings/comments for complex logic
6. [ ] CLAUDE.md updated if architecture changed
7. [ ] Commit message follows conventions

### Environment Variables

- Use `.env` for local configuration (in .gitignore)
- Maintain `.env.example` with all required variables (no real values)
- Load with `python-dotenv` (Python) or `dotenv` (Node.js)

```python
from dotenv import load_dotenv
import os

load_dotenv()
api_key = os.getenv("XAI_API_KEY")
```

### Testing Requirements

#### Backend Tests

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=src

# Run specific test file
pytest tests/test_trading.py -v
```

#### Frontend Tests

```bash
# Run tests
npm test

# Run with coverage
npm run test:coverage
```

### Documentation Updates

When to update CLAUDE.md:
- Adding new modules or components
- Changing architecture or data flow
- Adding new environment variables
- Modifying deployment process

When NOT to mention in docs:
- That code was generated by AI
- References to this instructions file
- Internal development processes

### Security Best Practices

1. **Input Validation**: Validate all user inputs and API responses
2. **Error Handling**: Never expose stack traces in production
3. **Logging**: Log security events, but never log sensitive data
4. **Dependencies**: Keep dependencies updated, check for vulnerabilities

```bash
# Python: Check for vulnerabilities
pip-audit

# Node.js: Check for vulnerabilities
npm audit
```

### Performance Guidelines

1. **API Calls**: Implement rate limiting and caching
2. **Database**: Use indexes for frequently queried fields
3. **WebSocket**: Implement reconnection with exponential backoff
4. **Frontend**: Use React Query for data fetching and caching

### Troubleshooting

If something breaks:

1. Check logs first: `docker compose logs -f [service]`
2. Verify environment variables are set
3. Check API connectivity (IBKR, xAI)
4. Review recent commits for changes
5. Test in isolation before integrating

### File Organization

```
# Group imports by type
import os                           # Standard library
import sys

from fastapi import FastAPI         # Third-party
from pydantic import BaseModel

from src.agent import GrokAgent     # Local
from src.broker import IBKRClient
```

### Comments

Write comments for **why**, not **what**:

```python
# Bad: Increment counter by 1
counter += 1

# Good: Retry count needed for exponential backoff
retry_count += 1
```

### Error Messages

Make errors actionable:

```python
# Bad
raise ValueError("Invalid input")

# Good
raise ValueError(
    f"Invalid symbol '{symbol}'. "
    f"Symbol must be 1-5 uppercase letters. "
    f"Example: 'AAPL', 'MSFT'"
)
```
